name: Auto-update Publii in WinGet

on:
  schedule:
    - cron: "17 14 * * *" # daily at 14:17 UTC / 6:17 AM Pacific
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: windows-latest
    steps:
      - name: Check for existing open PR
        id: check_pr
        shell: pwsh
        env:
          WINGET_CREATE_GITHUB_TOKEN: ${{ secrets.WINGET_CREATE_GITHUB_TOKEN }}
        run: |
          $headers = @{ Authorization = "Bearer $env:WINGET_CREATE_GITHUB_TOKEN"; Accept = "application/vnd.github+json"; "User-Agent" = "curl" }
          $query = 'repo:microsoft/winget-pkgs is:pr is:open in:title TidyCustoms.Publii'
          $url = "https://api.github.com/search/issues?q=$([uri]::EscapeDataString($query))&per_page=100&page=1"
          $resp = Invoke-RestMethod -Uri $url -Headers $headers -Method Get
          if ($resp.total_count -gt 0) {
            Write-Host "Open PR already exists. Skipping update."
            "pr_open=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } else {
            Write-Host "No open PR found. Continuing."
            "pr_open=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          }
      - name: Checkout Publii repo
        if: steps.check_pr.outputs.pr_open == 'false'
        uses: actions/checkout@v6
        with:
          repository: GetPublii/Publii
          fetch-depth: 1

      - name: Get latest stable tag
        if: steps.check_pr.outputs.pr_open == 'false'
        id: get_tag
        shell: pwsh
        run: |
          git fetch --tags
          $items = git tag --list | ForEach-Object {
            if ($_ -match '(\d+\.\d+\.\d+)') {
              [PSCustomObject]@{ Tag = $_; Base = [version]$Matches[1] }
            }
          }
          $latest = ($items | Sort-Object Base -Descending | Select-Object -First 1).Base.ToString()
          "tag=$latest" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "Latest Publii tag: $latest"

      - name: Check if version already exists in winget-pkgs
        if: steps.check_pr.outputs.pr_open == 'false'
        id: check_version
        shell: pwsh
        run: |
          $packageId = "TidyCustoms.Publii"
          $tag = "${{ steps.get_tag.outputs.tag }}"
          $url = "https://api.github.com/repos/microsoft/winget-pkgs/contents/manifests/t/TidyCustoms/Publii"
          $resp = Invoke-RestMethod -Uri $url -Headers @{ 'Accept' = 'application/vnd.github.v3+json'; 'Authorization' = "token ${{ secrets.WINGET_CREATE_GITHUB_TOKEN }}" }
          $versions = $resp | Where-Object { $_.type -eq 'dir' } | Select-Object -ExpandProperty name

          Write-Host "Versions currently in winget-pkgs for ${packageId}:"
          $versions | Sort-Object -Descending | ForEach-Object { Write-Host " - $_" }

          if ($versions -contains $tag) {
            Write-Host "Version $tag already exists in winget-pkgs. Skipping update."
            "skip=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } else {
            Write-Host "Version $tag not found in winget-pkgs. Will update."
            "skip=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          }

      - name: Download wingetcreate
        if: steps.check_pr.outputs.pr_open == 'false' && steps.check_version.outputs.skip == 'false'
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri https://aka.ms/wingetcreate/latest -OutFile wingetcreate.exe

      - name: Update WinGet package
        if: steps.check_pr.outputs.pr_open == 'false' && steps.check_version.outputs.skip == 'false'
        shell: pwsh
        env:
          TAG: ${{ steps.get_tag.outputs.tag }}
          # Use a classic PAT because fine-grained tokens are not supported by wingetcreate
          WINGET_CREATE_GITHUB_TOKEN: ${{ secrets.WINGET_CREATE_GITHUB_TOKEN }}
        run: |
          .\wingetcreate.exe update TidyCustoms.Publii `
            -u "https://getpublii.com/download/Publii-$env:TAG.exe|x64|user" `
            -v "$env:TAG" `
            --submit
